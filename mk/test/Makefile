.DEFAULT_GOAL := help
.PHONY: help sh sh-all sh-commit yaml yaml-all yaml-commit md md-all md-commit html html-all html-commit secrets secrets-all links py py-all

help:
	@echo "Testing Commands"
	@echo "================"
	@echo ""
	@echo "Test all files:"
	@echo "  make test sh              - Run shellcheck on all shell scripts"
	@echo "  make test yaml            - Run yamllint on all YAML files"
	@echo "  make test md              - Run pymarkdown on all Markdown files"
	@echo "  make test html            - Run html5lib on all HTML files"
	@echo "  make test py              - Run pytest and ruff on Python files"
	@echo "  make test secrets         - Run detect-secrets on all files"
	@echo "  make test links           - Validate all links and images (htmltest)"
	@echo ""
	@echo "Test single file (use FILE parameter):"
	@echo "  make test sh FILE=path/to/script.sh"
	@echo "  make test yaml FILE=path/to/file.yml"
	@echo "  make test md FILE=path/to/file.md"
	@echo "  make test html FILE=path/to/file.html"
	@echo "  make test py FILE=path/to/file.py"
	@echo ""
	@echo "Test committed files:"
	@echo "  make test sh-commit       - Run shellcheck on shell scripts in last commit"
	@echo "  make test yaml-commit     - Run yamllint on YAML files in last commit"
	@echo "  make test md-commit       - Run pymarkdown on Markdown files in last commit"
	@echo "  make test html-commit     - Run html5lib on HTML from changed files"
	@echo ""
	@echo "More info:"
	@echo "  See ADR-004 for testing requirements"

sh:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running shellcheck on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/shellcheck ]; then \
			if cd ../.. && .venv/bin/shellcheck --severity=error --format=gcc $(FILE); then \
				echo "‚úÖ Shellcheck passed"; \
			else \
				echo "‚ùå Shellcheck found issues in $(FILE)"; \
				exit 1; \
			fi; \
		elif command -v shellcheck >/dev/null 2>&1; then \
			if cd ../.. && shellcheck --severity=error --format=gcc $(FILE); then \
				echo "‚úÖ Shellcheck passed"; \
			else \
				echo "‚ùå Shellcheck found issues in $(FILE)"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå shellcheck not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	else \
		echo "üîç Running shellcheck on all shell scripts..."; \
		if [ -f ../../.venv/bin/shellcheck ]; then \
			if cd ../.. && find scripts -name "*.sh" -type f -exec .venv/bin/shellcheck --severity=error --format=gcc {} +; then \
				echo "‚úÖ Shellcheck passed"; \
			else \
				echo "‚ùå Shellcheck found issues"; \
				exit 1; \
			fi; \
		elif command -v shellcheck >/dev/null 2>&1; then \
			if cd ../.. && find scripts -name "*.sh" -type f -exec shellcheck --severity=error --format=gcc {} +; then \
				echo "‚úÖ Shellcheck passed"; \
			else \
				echo "‚ùå Shellcheck found issues"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå shellcheck not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

sh-all: sh

sh-commit:
	@echo "üîç Running shellcheck on shell scripts in last commit..."
	@if [ -f ../../.venv/bin/shellcheck ]; then \
		cd ../.. && shell_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.sh$$'); \
		if [ -n "$$shell_files" ]; then \
			if echo "$$shell_files" | xargs .venv/bin/shellcheck --severity=error --format=gcc; then \
				echo "‚úÖ Shellcheck passed"; \
			else \
				echo "‚ùå Shellcheck found issues in committed files"; \
				exit 1; \
			fi; \
		else \
			echo "‚ÑπÔ∏è  No shell scripts in last commit"; \
		fi; \
	elif command -v shellcheck >/dev/null 2>&1; then \
		cd ../.. && shell_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.sh$$'); \
		if [ -n "$$shell_files" ]; then \
			if echo "$$shell_files" | xargs shellcheck --severity=error --format=gcc; then \
				echo "‚úÖ Shellcheck passed"; \
			else \
				echo "‚ùå Shellcheck found issues in committed files"; \
				exit 1; \
			fi; \
		else \
			echo "‚ÑπÔ∏è  No shell scripts in last commit"; \
		fi; \
	else \
		echo "‚ùå shellcheck not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

yaml:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running yamllint on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/yamllint ]; then \
			if cd ../.. && .venv/bin/yamllint -c .github/yamllint-config.yml $(FILE); then \
				echo "‚úÖ Yamllint passed"; \
			else \
				echo "‚ùå Yamllint found issues in $(FILE)"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå yamllint not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	else \
		echo "üîç Running yamllint on all YAML files..."; \
		if [ -f ../../.venv/bin/yamllint ]; then \
			if cd ../.. && find . -name "*.yml" -o -name "*.yaml" | grep -v ".venv" | xargs .venv/bin/yamllint -c .github/yamllint-config.yml; then \
				echo "‚úÖ Yamllint passed"; \
			else \
				echo "‚ùå Yamllint found issues"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå yamllint not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

yaml-all: yaml

yaml-commit:
	@echo "üîç Running yamllint on YAML files in last commit..."
	@if [ -f ../../.venv/bin/yamllint ]; then \
		cd ../.. && yaml_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep -E '\.(yml|yaml)$$'); \
		if [ -n "$$yaml_files" ]; then \
			if echo "$$yaml_files" | xargs .venv/bin/yamllint -c .github/yamllint-config.yml; then \
				echo "‚úÖ Yamllint passed"; \
			else \
				echo "‚ùå Yamllint found issues in committed files"; \
				exit 1; \
			fi; \
		else \
			echo "‚ÑπÔ∏è  No YAML files in last commit"; \
		fi; \
	else \
		echo "‚ùå yamllint not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

md:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running pymarkdown on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/pymarkdown ]; then \
			if cd ../.. && .venv/bin/pymarkdown --config .pymarkdownlnt scan $(FILE); then \
				echo "‚úÖ Pymarkdown passed"; \
			else \
				echo "‚ùå Pymarkdown found issues in $(FILE)"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå pymarkdown not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	else \
		echo "üîç Running pymarkdown on all Markdown files..."; \
		if [ -f ../../.venv/bin/pymarkdown ]; then \
			if cd ../.. && find . -name "*.md" | grep -v ".venv" | xargs .venv/bin/pymarkdown --config .pymarkdownlnt scan; then \
				echo "‚úÖ Pymarkdown passed"; \
			else \
				echo "‚ùå Pymarkdown found issues"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå pymarkdown not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

md-all: md

md-commit:
	@echo "üîç Running pymarkdown on Markdown files in last commit..."
	@if [ -f ../../.venv/bin/pymarkdown ]; then \
		cd ../.. && md_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.md$$'); \
		if [ -n "$$md_files" ]; then \
			if echo "$$md_files" | xargs .venv/bin/pymarkdown --config .pymarkdownlnt scan; then \
				echo "‚úÖ Pymarkdown passed"; \
			else \
				echo "‚ùå Pymarkdown found issues in committed files"; \
				exit 1; \
			fi; \
		else \
			echo "‚ÑπÔ∏è  No Markdown files in last commit"; \
		fi; \
	else \
		echo "‚ùå pymarkdown not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

html:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running HTML validation on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh single $(FILE); \
	else \
		echo "üîç Running HTML validation on all files..."; \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh all; \
	fi

html-all: html

html-commit:
	@echo "üîç Running HTML validation on changed files..."
	@if [ -f ../../.venv/bin/python ]; then \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh changed; \
	elif command -v python3 >/dev/null 2>&1; then \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh changed; \
	else \
		echo "‚ùå Python not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

secrets: # pragma: allowlist secret
	@echo "üîç Running detect-secrets on all files..." # pragma: allowlist secret
	# pragma: allowlist secret
	@if [ -f ../../.venv/bin/detect-secrets ]; then \  # pragma: allowlist secret
		cd ../.. && .venv/bin/detect-secrets scan; \  # pragma: allowlist secret
	else \
		# pragma: allowlist secret
		echo "‚ùå detect-secrets not found"; \  # pragma: allowlist secret
		# pragma: allowlist secret
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

secrets-all: secrets # pragma: allowlist secret

links:
	@echo "üîó Validating all links and images with htmltest..."
	@if ! command -v htmltest >/dev/null 2>&1; then \
		echo "‚ùå htmltest not found"; \
		echo "Install: brew install htmltest"; \
		exit 1; \
	fi
	@if [ ! -d ../../website/public ]; then \
		echo "‚ùå website/public not found"; \
		echo "Run 'cd website && hugo' to build site first"; \
		exit 1; \
	fi
	@cd ../.. && htmltest

py:
	@if [ -n "$(FILE)" ]; then \
		echo "üêç Running Python linting on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/ruff ]; then \
			if cd ../.. && .venv/bin/ruff check $(FILE); then \
				echo "‚úÖ Python linting passed"; \
			else \
				echo "‚ùå Ruff found issues in $(FILE)"; \
				exit 1; \
			fi; \
		elif command -v ruff >/dev/null 2>&1; then \
			if cd ../.. && ruff check $(FILE); then \
				echo "‚úÖ Python linting passed"; \
			else \
				echo "‚ùå Ruff found issues in $(FILE)"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå ruff not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	else \
		echo "üêç Running Python tests and linting..."; \
		if [ -f ../../.venv/bin/pytest ]; then \
			if cd ../.. && .venv/bin/ruff check scripts/; then \
				echo "‚úÖ Ruff linting passed"; \
			else \
				echo "‚ùå Ruff found issues"; \
				exit 1; \
			fi; \
			if .venv/bin/pytest; then \
				echo "‚úÖ Python tests passed"; \
			else \
				echo "‚ùå Pytest failed"; \
				exit 1; \
			fi; \
		elif command -v pytest >/dev/null 2>&1 && command -v ruff >/dev/null 2>&1; then \
			if cd ../.. && ruff check scripts/; then \
				echo "‚úÖ Ruff linting passed"; \
			else \
				echo "‚ùå Ruff found issues"; \
				exit 1; \
			fi; \
			if pytest; then \
				echo "‚úÖ Python tests passed"; \
			else \
				echo "‚ùå Pytest failed"; \
				exit 1; \
			fi; \
		else \
			echo "‚ùå pytest or ruff not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

py-all: py
