.DEFAULT_GOAL := help
.PHONY: help sh sh-all sh-commit yaml yaml-all yaml-commit md md-all md-commit html html-all html-commit secrets secrets-all links py py-all

help:
	@echo "Testing Commands"
	@echo "================"
	@echo ""
	@echo "Test all files:"
	@echo "  make test sh              - Run shellcheck on all shell scripts"
	@echo "  make test yaml            - Run yamllint on all YAML files"
	@echo "  make test md              - Run pymarkdown on all Markdown files"
	@echo "  make test html            - Run html5lib on all HTML files"
	@echo "  make test py              - Run pytest and ruff on Python files"
	@echo "  make test secrets         - Run detect-secrets on all files"
	@echo "  make test links           - Check critical internal links"
	@echo ""
	@echo "Test single file (use FILE parameter):"
	@echo "  make test sh FILE=path/to/script.sh"
	@echo "  make test yaml FILE=path/to/file.yml"
	@echo "  make test md FILE=path/to/file.md"
	@echo "  make test html FILE=path/to/file.html"
	@echo "  make test py FILE=path/to/file.py"
	@echo ""
	@echo "Test committed files:"
	@echo "  make test sh-commit       - Run shellcheck on shell scripts in last commit"
	@echo "  make test yaml-commit     - Run yamllint on YAML files in last commit"
	@echo "  make test md-commit       - Run pymarkdown on Markdown files in last commit"
	@echo "  make test html-commit     - Run html5lib on HTML from changed files"
	@echo ""
	@echo "More info:"
	@echo "  See ADR-004 for testing requirements"

sh:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running shellcheck on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/shellcheck ]; then \
			cd ../.. && .venv/bin/shellcheck --format=gcc $(FILE); \
		elif command -v shellcheck >/dev/null 2>&1; then \
			cd ../.. && shellcheck --format=gcc $(FILE); \
		else \
			echo "‚ùå shellcheck not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
		echo "‚úÖ Shellcheck complete"; \
	else \
		echo "üîç Running shellcheck on all shell scripts..."; \
		if [ -f ../../.venv/bin/shellcheck ]; then \
			cd ../.. && find scripts -name "*.sh" -type f -exec .venv/bin/shellcheck --format=gcc {} +; \
			echo "‚úÖ Shellcheck complete"; \
		elif command -v shellcheck >/dev/null 2>&1; then \
			cd ../.. && find scripts -name "*.sh" -type f -exec shellcheck --format=gcc {} +; \
			echo "‚úÖ Shellcheck complete"; \
		else \
			echo "‚ùå shellcheck not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

sh-all: sh

sh-commit:
	@echo "üîç Running shellcheck on shell scripts in last commit..."
	@if [ -f ../../.venv/bin/shellcheck ]; then \
		cd ../.. && shell_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.sh$$'); \
		if [ -n "$$shell_files" ]; then \
			echo "$$shell_files" | xargs .venv/bin/shellcheck --format=gcc && echo "‚úÖ Shellcheck passed" || echo "‚ùå Shellcheck found issues"; \
		else \
			echo "‚ÑπÔ∏è  No shell scripts in last commit"; \
		fi; \
	elif command -v shellcheck >/dev/null 2>&1; then \
		cd ../.. && shell_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.sh$$'); \
		if [ -n "$$shell_files" ]; then \
			echo "$$shell_files" | xargs shellcheck --format=gcc && echo "‚úÖ Shellcheck passed" || echo "‚ùå Shellcheck found issues"; \
		else \
			echo "‚ÑπÔ∏è  No shell scripts in last commit"; \
		fi; \
	else \
		echo "‚ùå shellcheck not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

yaml:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running yamllint on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/yamllint ]; then \
			cd ../.. && .venv/bin/yamllint -c .github/yamllint-config.yml $(FILE); \
		else \
			echo "‚ùå yamllint not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
		echo "‚úÖ Yamllint complete"; \
	else \
		echo "üîç Running yamllint on all YAML files..."; \
		if [ -f ../../.venv/bin/yamllint ]; then \
			cd ../.. && find . -name "*.yml" -o -name "*.yaml" | grep -v ".venv" | xargs .venv/bin/yamllint -c .github/yamllint-config.yml; \
			echo "‚úÖ Yamllint complete"; \
		else \
			echo "‚ùå yamllint not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

yaml-all: yaml

yaml-commit:
	@echo "üîç Running yamllint on YAML files in last commit..."
	@if [ -f ../../.venv/bin/yamllint ]; then \
		cd ../.. && yaml_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep -E '\.(yml|yaml)$$'); \
		if [ -n "$$yaml_files" ]; then \
			echo "$$yaml_files" | xargs .venv/bin/yamllint -c .github/yamllint-config.yml && echo "‚úÖ Yamllint passed" || echo "‚ùå Yamllint found issues"; \
		else \
			echo "‚ÑπÔ∏è  No YAML files in last commit"; \
		fi; \
	else \
		echo "‚ùå yamllint not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

md:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running pymarkdown on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/pymarkdown ]; then \
			cd ../.. && .venv/bin/pymarkdown --config .pymarkdownlnt scan $(FILE); \
		else \
			echo "‚ùå pymarkdown not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
		echo "‚úÖ Pymarkdown complete"; \
	else \
		echo "üîç Running pymarkdown on all Markdown files..."; \
		if [ -f ../../.venv/bin/pymarkdown ]; then \
			cd ../.. && find . -name "*.md" | grep -v ".venv" | xargs .venv/bin/pymarkdown --config .pymarkdownlnt scan; \
			echo "‚úÖ Pymarkdown complete"; \
		else \
			echo "‚ùå pymarkdown not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

md-all: md

md-commit:
	@echo "üîç Running pymarkdown on Markdown files in last commit..."
	@if [ -f ../../.venv/bin/pymarkdown ]; then \
		cd ../.. && md_files=$$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.md$$'); \
		if [ -n "$$md_files" ]; then \
			echo "$$md_files" | xargs .venv/bin/pymarkdown --config .pymarkdownlnt scan && echo "‚úÖ Pymarkdown passed" || echo "‚ùå Pymarkdown found issues"; \
		else \
			echo "‚ÑπÔ∏è  No Markdown files in last commit"; \
		fi; \
	else \
		echo "‚ùå pymarkdown not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

html:
	@if [ -n "$(FILE)" ]; then \
		echo "üîç Running HTML validation on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh single $(FILE); \
	else \
		echo "üîç Running HTML validation on all files..."; \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh all; \
	fi

html-all: html

html-commit:
	@echo "üîç Running HTML validation on changed files..."
	@if [ -f ../../.venv/bin/python ]; then \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh changed; \
	elif command -v python3 >/dev/null 2>&1; then \
		cd ../.. && chmod +x scripts/test-html.sh && scripts/test-html.sh changed; \
	else \
		echo "‚ùå Python not found"; \
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

secrets: # pragma: allowlist secret
	@echo "üîç Running detect-secrets on all files..." # pragma: allowlist secret
	@if [ -f ../../.venv/bin/detect-secrets ]; then \ # pragma: allowlist secret
		cd ../.. && .venv/bin/detect-secrets scan; \ # pragma: allowlist secret
	else \
		echo "‚ùå detect-secrets not found"; \ # pragma: allowlist secret
		echo "Run 'make hooks setup' to install locally"; \
		exit 1; \
	fi

secrets-all: secrets # pragma: allowlist secret

links:
	@echo "üîó Checking critical internal links..."
	@if [ -f ../../scripts/pre-push-link-checker.sh ]; then \
		cd ../.. && chmod +x scripts/pre-push-link-checker.sh && scripts/pre-push-link-checker.sh; \
	else \
		echo "‚ùå Link checker script not found"; \
		exit 1; \
	fi

py:
	@if [ -n "$(FILE)" ]; then \
		echo "üêç Running Python linting on $(FILE)..."; \
		if [ ! -f "../../$(FILE)" ]; then \
			echo "‚ùå File not found: $(FILE)"; \
			exit 1; \
		fi; \
		if [ -f ../../.venv/bin/ruff ]; then \
			cd ../.. && (.venv/bin/ruff check $(FILE) || echo "‚ö†Ô∏è  Ruff found issues but continuing..."); \
		elif command -v ruff >/dev/null 2>&1; then \
			cd ../.. && (ruff check $(FILE) || echo "‚ö†Ô∏è  Ruff found issues but continuing..."); \
		else \
			echo "‚ùå ruff not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
		echo "‚úÖ Python linting complete"; \
	else \
		echo "üêç Running Python tests and linting..."; \
		if [ -f ../../.venv/bin/pytest ]; then \
			cd ../.. && (.venv/bin/ruff check scripts/ || echo "‚ö†Ô∏è  Ruff found issues but continuing...") && \
			.venv/bin/pytest && echo "‚úÖ Pytest complete"; \
		elif command -v pytest >/dev/null 2>&1 && command -v ruff >/dev/null 2>&1; then \
			cd ../.. && (ruff check scripts/ || echo "‚ö†Ô∏è  Ruff found issues but continuing...") && \
			pytest && echo "‚úÖ Pytest complete"; \
		else \
			echo "‚ùå pytest or ruff not found"; \
			echo "Run 'make hooks setup' to install locally"; \
			exit 1; \
		fi; \
	fi

py-all: py
